Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _languageclient = require('../languageclient');

var _convert = require('../convert');

var _convert2 = _interopRequireDefault(_convert);

var _atom = require('atom');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let DocumentSyncAdapter = class DocumentSyncAdapter {

  constructor(languageClient, documentSyncKind) {
    this._disposable = new _atom.CompositeDisposable();
    this._editors = new WeakMap();

    this._lc = languageClient;
    this._documentSyncKind = documentSyncKind;
    this._disposable.add(atom.textEditors.observe(this.observeTextEditors.bind(this)));
  }

  dispose() {
    this._disposable.dispose();
  }

  observeTextEditors(editor) {
    if (!this._editors.has(editor)) {
      const sync = new TextEditorSyncAdapter(editor, this._lc, this._documentSyncKind);
      this._editors.set(editor, sync);
      this._disposable.add(sync);
      this._disposable.add(editor.onDidDestroy(() => {
        this._editors.delete(editor);
        this._disposable.remove(sync);
        sync.dispose();
      }));
    }
  }
};
exports.default = DocumentSyncAdapter;
let TextEditorSyncAdapter = class TextEditorSyncAdapter {

  constructor(editor, languageClient, documentSyncKind) {
    this._disposable = new _atom.CompositeDisposable();
    this._version = 1;

    this._editor = editor;
    this._lc = languageClient;

    const changeTracking = this.setupChangeTracking(documentSyncKind);
    if (changeTracking != null) {
      this._disposable.add(changeTracking);
    }

    this._disposable.add(editor.onDidSave(this.didSave.bind(this)), editor.onDidDestroy(this.didDestroy.bind(this)));

    this.didOpen();
  }

  setupChangeTracking(documentSyncKind) {
    switch (documentSyncKind) {
      case _languageclient.TextDocumentSyncKind.Full:
        return this._editor.onDidChange(this.editorChangeSendFull.bind(this));
      case _languageclient.TextDocumentSyncKind.Incremental:
        // TODO: Switch to onDidChangeText when the API includes oldText.
        return this._editor.getBuffer().onDidChange(this.bufferChangeSendIncrement.bind(this));
    }
    return null;
  }

  dispose() {
    this._disposable.dispose();
  }

  getLanguageId() {
    return this._editor.getGrammar().name;
  }

  getVersionedTextDocumentIdentifier() {
    return {
      uri: this.getEditorUri(),
      version: this._version
    };
  }

  didOpen() {
    this._lc.didOpenTextDocument({
      textDocument: {
        uri: this.getEditorUri(),
        languageId: this.getLanguageId().toLowerCase(),
        version: this._version,
        text: this._editor.getText()
      }
    });
  }

  editorChangeSendFull() {
    this._version++;
    this._lc.didChangeTextDocument({
      textDocument: this.getVersionedTextDocumentIdentifier(),
      contentChanges: [{ text: this._editor.getText() }]
    });
  }

  bufferChangeSendIncrement(event) {
    this._version++;
    this._lc.didChangeTextDocument({
      textDocument: this.getVersionedTextDocumentIdentifier(),
      contentChanges: [TextEditorSyncAdapter.textEditToContentChange(event)]
    });
  }

  static textEditToContentChange(change) {
    return {
      range: _convert2.default.atomRangeToLSRange(change.oldRange),
      rangeLength: change.oldText.length,
      text: change.newText
    };
  }

  didDestroy() {
    this._lc.didCloseTextDocument({ textDocument: { uri: this.getEditorUri() } });
  }

  didSave() {
    this._lc.didSaveTextDocument({ textDocument: { uri: this.getEditorUri() } });
    this._lc.didChangeWatchedFiles({ changes: [{ uri: this.getEditorUri(), type: _languageclient.FileChangeType.Changed }] });
  }

  getEditorUri() {
    return _convert2.default.pathToUri(this._editor.getURI() || '');
  }
};
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9hZGFwdGVycy9kb2N1bWVudC1zeW5jLWFkYXB0ZXIuanMiXSwibmFtZXMiOlsiRG9jdW1lbnRTeW5jQWRhcHRlciIsImNvbnN0cnVjdG9yIiwibGFuZ3VhZ2VDbGllbnQiLCJkb2N1bWVudFN5bmNLaW5kIiwiX2Rpc3Bvc2FibGUiLCJfZWRpdG9ycyIsIldlYWtNYXAiLCJfbGMiLCJfZG9jdW1lbnRTeW5jS2luZCIsImFkZCIsImF0b20iLCJ0ZXh0RWRpdG9ycyIsIm9ic2VydmUiLCJvYnNlcnZlVGV4dEVkaXRvcnMiLCJiaW5kIiwiZGlzcG9zZSIsImVkaXRvciIsImhhcyIsInN5bmMiLCJUZXh0RWRpdG9yU3luY0FkYXB0ZXIiLCJzZXQiLCJvbkRpZERlc3Ryb3kiLCJkZWxldGUiLCJyZW1vdmUiLCJfdmVyc2lvbiIsIl9lZGl0b3IiLCJjaGFuZ2VUcmFja2luZyIsInNldHVwQ2hhbmdlVHJhY2tpbmciLCJvbkRpZFNhdmUiLCJkaWRTYXZlIiwiZGlkRGVzdHJveSIsImRpZE9wZW4iLCJGdWxsIiwib25EaWRDaGFuZ2UiLCJlZGl0b3JDaGFuZ2VTZW5kRnVsbCIsIkluY3JlbWVudGFsIiwiZ2V0QnVmZmVyIiwiYnVmZmVyQ2hhbmdlU2VuZEluY3JlbWVudCIsImdldExhbmd1YWdlSWQiLCJnZXRHcmFtbWFyIiwibmFtZSIsImdldFZlcnNpb25lZFRleHREb2N1bWVudElkZW50aWZpZXIiLCJ1cmkiLCJnZXRFZGl0b3JVcmkiLCJ2ZXJzaW9uIiwiZGlkT3BlblRleHREb2N1bWVudCIsInRleHREb2N1bWVudCIsImxhbmd1YWdlSWQiLCJ0b0xvd2VyQ2FzZSIsInRleHQiLCJnZXRUZXh0IiwiZGlkQ2hhbmdlVGV4dERvY3VtZW50IiwiY29udGVudENoYW5nZXMiLCJldmVudCIsInRleHRFZGl0VG9Db250ZW50Q2hhbmdlIiwiY2hhbmdlIiwicmFuZ2UiLCJhdG9tUmFuZ2VUb0xTUmFuZ2UiLCJvbGRSYW5nZSIsInJhbmdlTGVuZ3RoIiwib2xkVGV4dCIsImxlbmd0aCIsIm5ld1RleHQiLCJkaWRDbG9zZVRleHREb2N1bWVudCIsImRpZFNhdmVUZXh0RG9jdW1lbnQiLCJkaWRDaGFuZ2VXYXRjaGVkRmlsZXMiLCJjaGFuZ2VzIiwidHlwZSIsIkNoYW5nZWQiLCJwYXRoVG9VcmkiLCJnZXRVUkkiXSwibWFwcGluZ3MiOiI7Ozs7O0FBRUE7O0FBRUE7Ozs7QUFDQTs7OztJQUVxQkEsbUIsR0FBTixNQUFNQSxtQkFBTixDQUEwQjs7QUFNdkNDLGNBQVlDLGNBQVosRUFBc0RDLGdCQUF0RCxFQUFnRjtBQUFBLFNBTGhGQyxXQUtnRixHQUxsRSwrQkFLa0U7QUFBQSxTQUhoRkMsUUFHZ0YsR0FIcEIsSUFBSUMsT0FBSixFQUdvQjs7QUFDOUUsU0FBS0MsR0FBTCxHQUFXTCxjQUFYO0FBQ0EsU0FBS00saUJBQUwsR0FBeUJMLGdCQUF6QjtBQUNBLFNBQUtDLFdBQUwsQ0FBaUJLLEdBQWpCLENBQXFCQyxLQUFLQyxXQUFMLENBQWlCQyxPQUFqQixDQUF5QixLQUFLQyxrQkFBTCxDQUF3QkMsSUFBeEIsQ0FBNkIsSUFBN0IsQ0FBekIsQ0FBckI7QUFDRDs7QUFFREMsWUFBZ0I7QUFDZCxTQUFLWCxXQUFMLENBQWlCVyxPQUFqQjtBQUNEOztBQUVERixxQkFBbUJHLE1BQW5CLEVBQWtEO0FBQ2hELFFBQUksQ0FBQyxLQUFLWCxRQUFMLENBQWNZLEdBQWQsQ0FBa0JELE1BQWxCLENBQUwsRUFBZ0M7QUFDOUIsWUFBTUUsT0FBTyxJQUFJQyxxQkFBSixDQUEwQkgsTUFBMUIsRUFBa0MsS0FBS1QsR0FBdkMsRUFBNEMsS0FBS0MsaUJBQWpELENBQWI7QUFDQSxXQUFLSCxRQUFMLENBQWNlLEdBQWQsQ0FBa0JKLE1BQWxCLEVBQTBCRSxJQUExQjtBQUNBLFdBQUtkLFdBQUwsQ0FBaUJLLEdBQWpCLENBQXFCUyxJQUFyQjtBQUNBLFdBQUtkLFdBQUwsQ0FBaUJLLEdBQWpCLENBQXFCTyxPQUFPSyxZQUFQLENBQW9CLE1BQU07QUFDN0MsYUFBS2hCLFFBQUws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QyxhQUFPLGtCQUFRQyxrQkFBUixDQUEyQkYsT0FBT0csUUFBbEMsQ0FERjtBQUVMQyxtQkFBYUosT0FBT0ssT0FBUCxDQUFlQyxNQUZ2QjtBQUdMWixZQUFNTSxPQUFPTztBQUhSLEtBQVA7QUFLRDs7QUFFRGhDLGVBQW1CO0FBQ2pCLFNBQUt2QixHQUFMLENBQVN3RCxvQkFBVCxDQUE4QixFQUFFakIsY0FBYyxFQUFFSixLQUFLLEtBQUtDLFlBQUwsRUFBUCxFQUFoQixFQUE5QjtBQUNEOztBQUVEZCxZQUFnQjtBQUNkLFNBQUt0QixHQUFMLENBQVN5RCxtQkFBVCxDQUE2QixFQUFFbEIsY0FBYyxFQUFFSixLQUFLLEtBQUtDLFlBQUwsRUFBUCxFQUFoQixFQUE3QjtBQUNBLFNBQUtwQyxHQUFMLENBQVMwRCxxQkFBVCxDQUErQixFQUFFQyxTQUFTLENBQUUsRUFBRXhCLEtBQUssS0FBS0MsWUFBTCxFQUFQLEVBQTRCd0IsTUFBTSwrQkFBZUMsT0FBakQsRUFBRixDQUFYLEVBQS9CO0FBQ0Q7O0FBRUR6QixpQkFBdUI7QUFDckIsV0FBTyxrQkFBUTBCLFNBQVIsQ0FBa0IsS0FBSzVDLE9BQUwsQ0FBYTZDLE1BQWIsTUFBeUIsRUFBM0MsQ0FBUDtBQUNEO0FBL0Z5QixDIiwiZmlsZSI6ImRvY3VtZW50LXN5bmMtYWRhcHRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCB7TGFuZ3VhZ2VDbGllbnRDb25uZWN0aW9uLCBGaWxlQ2hhbmdlVHlwZSwgVGV4dERvY3VtZW50U3luY0tpbmR9IGZyb20gJy4uL2xhbmd1YWdlY2xpZW50JztcbmltcG9ydCB0eXBlIHtUZXh0RG9jdW1lbnRDb250ZW50Q2hhbmdlRXZlbnQsIFZlcnNpb25lZFRleHREb2N1bWVudElkZW50aWZpZXJ9IGZyb20gJy4uL2xhbmd1YWdlY2xpZW50JztcbmltcG9ydCBDb252ZXJ0IGZyb20gJy4uL2NvbnZlcnQnO1xuaW1wb3J0IHtDb21wb3NpdGVEaXNwb3NhYmxlfSBmcm9tICdhdG9tJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRG9jdW1lbnRTeW5jQWRhcHRlciB7XG4gIF9kaXNwb3NhYmxlID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcbiAgX2RvY3VtZW50U3luY0tpbmQ6IG51bWJlcjtcbiAgX2VkaXRvcnM6IFdlYWtNYXA8YXRvbSRUZXh0RWRpdG9yLCBUZXh0RWRpdG9yU3luY0FkYXB0ZXI+ID0gbmV3IFdlYWtNYXAoKTtcbiAgX2xjOiBMYW5ndWFnZUNsaWVudENvbm5lY3Rpb247XG5cbiAgY29uc3RydWN0b3IobGFuZ3VhZ2VDbGllbnQ6IExhbmd1YWdlQ2xpZW50Q29ubmVjdGlvbiwgZG9jdW1lbnRTeW5jS2luZDogbnVtYmVyKSB7XG4gICAgdGhpcy5fbGMgPSBsYW5ndWFnZUNsaWVudDtcbiAgICB0aGlzLl9kb2N1bWVudFN5bmNLaW5kID0gZG9jdW1lbnRTeW5jS2luZDtcbiAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChhdG9tLnRleHRFZGl0b3JzLm9ic2VydmUodGhpcy5vYnNlcnZlVGV4dEVkaXRvcnMuYmluZCh0aGlzKSkpO1xuICB9XG5cbiAgZGlzcG9zZSgpOiB2b2lkIHtcbiAgICB0aGlzLl9kaXNwb3NhYmxlLmRpc3Bvc2UoKTtcbiAgfVxuXG4gIG9ic2VydmVUZXh0RWRpdG9ycyhlZGl0b3I6IGF0b20kVGV4dEVkaXRvcik6IHZvaWQge1xuICAgIGlmICghdGhpcy5fZWRpdG9ycy5oYXMoZWRpdG9yKSkge1xuICAgICAgY29uc3Qgc3luYyA9IG5ldyBUZXh0RWRpdG9yU3luY0FkYXB0ZXIoZWRpdG9yLCB0aGlzLl9sYywgdGhpcy5fZG9jdW1lbnRTeW5jS2luZCk7XG4gICAgICB0aGlzLl9lZGl0b3JzLnNldChlZGl0b3IsIHN5bmMpO1xuICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQoc3luYyk7XG4gICAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChlZGl0b3Iub25EaWREZXN0cm95KCgpID0+IHtcbiAgICAgICAgdGhpcy5fZWRpdG9ycy5kZWxldGUoZWRpdG9yKTtcbiAgICAgICAgdGhpcy5fZGlzcG9zYWJsZS5yZW1vdmUoc3luYyk7XG4gICAgICAgIHN5bmMuZGlzcG9zZSgpO1xuICAgICAgfSkpO1xuICAgIH1cbiAgfVxufVxuXG5jbGFzcyBUZXh0RWRpdG9yU3luY0FkYXB0ZXIge1xuICBfZGlzcG9zYWJsZSA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG4gIF9lZGl0b3I6IGF0b20kVGV4dEVkaXRvcjtcbiAgX2xjOiBMYW5ndWFnZUNsaWVudENvbm5lY3Rpb247XG4gIF92ZXJzaW9uID0gMTtcblxuICBjb25zdHJ1Y3RvcihlZGl0b3I6IGF0b20kVGV4dEVkaXRvciwgbGFuZ3VhZ2VDbGllbnQ6IExhbmd1YWdlQ2xpZW50Q29ubmVjdGlvbiwgZG9jdW1lbnRTeW5jS2luZDogbnVtYmVyKSB7XG4gICAgdGhpcy5fZWRpdG9yID0gZWRpdG9yO1xuICAgIHRoaXMuX2xjID0gbGFuZ3VhZ2VDbGllbnQ7XG5cbiAgICBjb25zdCBjaGFuZ2VUcmFja2luZyA9IHRoaXMuc2V0dXBDaGFuZ2VUcmFja2luZyhkb2N1bWVudFN5bmNLaW5kKTtcbiAgICBpZiAoY2hhbmdlVHJhY2tpbmcgIT0gbnVsbCkge1xuICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQoY2hhbmdlVHJhY2tpbmcpO1xuICAgIH1cblxuICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKFxuICAgICAgZWRpdG9yLm9uRGlkU2F2ZSh0aGlzLmRpZFNhdmUuYmluZCh0aGlzKSksXG4gICAgICBlZGl0b3Iub25EaWREZXN0cm95KHRoaXMuZGlkRGVzdHJveS5iaW5kKHRoaXMpKSxcbiAgICApO1xuXG4gICAgdGhpcy5kaWRPcGVuKCk7XG4gIH1cblxuICBzZXR1cENoYW5nZVRyYWNraW5nKGRvY3VtZW50U3luY0tpbmQ6IG51bWJlcik6ID9JRGlzcG9zYWJsZSB7XG4gICAgc3dpdGNoIChkb2N1bWVudFN5bmNLaW5kKSB7XG4gICAgICBjYXNlIFRleHREb2N1bWVudFN5bmNLaW5kLkZ1bGw6XG4gICAgICAgIHJldHVybiB0aGlzLl9lZGl0b3Iub25EaWRDaGFuZ2UodGhpcy5lZGl0b3JDaGFuZ2VTZW5kRnVsbC5iaW5kKHRoaXMpKTtcbiAgICAgIGNhc2UgVGV4dERvY3VtZW50U3luY0tpbmQuSW5jcmVtZW50YWw6XG4gICAgICAgIC8vIFRPRE86IFN3aXRjaCB0byBvbkRpZENoYW5nZVRleHQgd2hlbiB0aGUgQVBJIGluY2x1ZGVzIG9sZFRleHQuXG4gICAgICAgIHJldHVybiB0aGlzLl9lZGl0b3IuZ2V0QnVmZmVyKCkub25EaWRDaGFuZ2UodGhpcy5idWZmZXJDaGFuZ2VTZW5kSW5jcmVtZW50LmJpbmQodGhpcykpO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGRpc3Bvc2UoKTogdm9pZCB7XG4gICAgdGhpcy5fZGlzcG9zYWJsZS5kaXNwb3NlKCk7XG4gIH1cblxuICBnZXRMYW5ndWFnZUlkKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuX2VkaXRvci5nZXRHcmFtbWFyKCkubmFtZTtcbiAgfVxuXG4gIGdldFZlcnNpb25lZFRleHREb2N1bWVudElkZW50aWZpZXIoKTogVmVyc2lvbmVkVGV4dERvY3VtZW50SWRlbnRpZmllciB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHVyaTogdGhpcy5nZXRFZGl0b3JVcmkoKSxcbiAgICAgIHZlcnNpb246IHRoaXMuX3ZlcnNpb25cbiAgICB9O1xuICB9XG5cbiAgZGlkT3BlbigpOiB2b2lkIHtcbiAgICB0aGlzLl9sYy5kaWRPcGVuVGV4dERvY3VtZW50KHtcbiAgICAgIHRleHREb2N1bWVudDoge1xuICAgICAgICB1cmk6IHRoaXMuZ2V0RWRpdG9yVXJpKCksXG4gICAgICAgIGxhbmd1YWdlSWQ6IHRoaXMuZ2V0TGFuZ3VhZ2VJZCgpLnRvTG93ZXJDYXNlKCksXG4gICAgICAgIHZlcnNpb246IHRoaXMuX3ZlcnNpb24sXG4gICAgICAgIHRleHQ6IHRoaXMuX2VkaXRvci5nZXRUZXh0KClcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGVkaXRvckNoYW5nZVNlbmRGdWxsKCk6IHZvaWQge1xuICAgIHRoaXMuX3ZlcnNpb24rKztcbiAgICB0aGlzLl9sYy5kaWRDaGFuZ2VUZXh0RG9jdW1lbnQoe1xuICAgICAgdGV4dERvY3VtZW50OiB0aGlzLmdldFZlcnNpb25lZFRleHREb2N1bWVudElkZW50aWZpZXIoKSxcbiAgICAgIGNvbnRlbnRDaGFuZ2VzOiBbIHsgdGV4dDogdGhpcy5fZWRpdG9yLmdldFRleHQoKSB9IF1cbiAgICB9KTtcbiAgfVxuXG4gIGJ1ZmZlckNoYW5nZVNlbmRJbmNyZW1lbnQoZXZlbnQ6IGF0b20kVGV4dEVkaXRFdmVudCk6IHZvaWQge1xuICAgIHRoaXMuX3ZlcnNpb24rKztcbiAgICB0aGlzLl9sYy5kaWRDaGFuZ2VUZXh0RG9jdW1lbnQoe1xuICAgICAgdGV4dERvY3VtZW50OiB0aGlzLmdldFZlcnNpb25lZFRleHREb2N1bWVudElkZW50aWZpZXIoKSxcbiAgICAgIGNvbnRlbnRDaGFuZ2VzOiBbVGV4dEVkaXRvclN5bmNBZGFwdGVyLnRleHRFZGl0VG9Db250ZW50Q2hhbmdlKGV2ZW50KV0sXG4gICAgfSk7XG4gIH1cblxuICBzdGF0aWMgdGV4dEVkaXRUb0NvbnRlbnRDaGFuZ2UoY2hhbmdlOiBhdG9tJFRleHRFZGl0RXZlbnQpOiBUZXh0RG9jdW1lbnRDb250ZW50Q2hhbmdlRXZlbnQge1xuICAgIHJldHVybiB7XG4gICAgICByYW5nZTogQ29udmVydC5hdG9tUmFuZ2VUb0xTUmFuZ2UoY2hhbmdlLm9sZFJhbmdlKSxcbiAgICAgIHJhbmdlTGVuZ3RoOiBjaGFuZ2Uub2xkVGV4dC5sZW5ndGgsXG4gICAgICB0ZXh0OiBjaGFuZ2UubmV3VGV4dFxuICAgIH07XG4gIH1cblxuICBkaWREZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuX2xjLmRpZENsb3NlVGV4dERvY3VtZW50KHsgdGV4dERvY3VtZW50OiB7IHVyaTogdGhpcy5nZXRFZGl0b3JVcmkoKSB9IH0pO1xuICB9XG5cbiAgZGlkU2F2ZSgpOiB2b2lkIHtcbiAgICB0aGlzLl9sYy5kaWRTYXZlVGV4dERvY3VtZW50KHsgdGV4dERvY3VtZW50OiB7IHVyaTogdGhpcy5nZXRFZGl0b3JVcmkoKSB9IH0pO1xuICAgIHRoaXMuX2xjLmRpZENoYW5nZVdhdGNoZWRGaWxlcyh7IGNoYW5nZXM6IFsgeyB1cmk6IHRoaXMuZ2V0RWRpdG9yVXJpKCksIHR5cGU6IEZpbGVDaGFuZ2VUeXBlLkNoYW5nZWQgfSBdfSk7XG4gIH1cblxuICBnZXRFZGl0b3JVcmkoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gQ29udmVydC5wYXRoVG9VcmkodGhpcy5fZWRpdG9yLmdldFVSSSgpIHx8ICcnKTtcbiAgfVxufVxuIl19
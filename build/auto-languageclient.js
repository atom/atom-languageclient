Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _child_process = require('child_process');

var cp = _interopRequireWildcard(_child_process);

var _languageclient = require('./languageclient');

var ls = _interopRequireWildcard(_languageclient);

var _vscodeJsonrpc = require('vscode-jsonrpc');

var rpc = _interopRequireWildcard(_vscodeJsonrpc);

var _consoleLogger = require('./loggers/console-logger');

var _consoleLogger2 = _interopRequireDefault(_consoleLogger);

var _nullLogger = require('./loggers/null-logger');

var _nullLogger2 = _interopRequireDefault(_nullLogger);

var _autocompleteAdapter = require('./adapters/autocomplete-adapter');

var _autocompleteAdapter2 = _interopRequireDefault(_autocompleteAdapter);

var _documentSyncAdapter = require('./adapters/document-sync-adapter');

var _documentSyncAdapter2 = _interopRequireDefault(_documentSyncAdapter);

var _formatCodeAdapter = require('./adapters/format-code-adapter');

var _formatCodeAdapter2 = _interopRequireDefault(_formatCodeAdapter);

var _linterAdapter = require('./adapters/linter-adapter');

var _linterAdapter2 = _interopRequireDefault(_linterAdapter);

var _notificationsAdapter = require('./adapters/notifications-adapter');

var _notificationsAdapter2 = _interopRequireDefault(_notificationsAdapter);

var _nuclideDefinitionAdapter = require('./adapters/nuclide-definition-adapter');

var _nuclideDefinitionAdapter2 = _interopRequireDefault(_nuclideDefinitionAdapter);

var _nuclideFindReferencesAdapter = require('./adapters/nuclide-find-references-adapter');

var _nuclideFindReferencesAdapter2 = _interopRequireDefault(_nuclideFindReferencesAdapter);

var _nuclideHyperclickAdapter = require('./adapters/nuclide-hyperclick-adapter');

var _nuclideHyperclickAdapter2 = _interopRequireDefault(_nuclideHyperclickAdapter);

var _nuclideOutlineViewAdapter = require('./adapters/nuclide-outline-view-adapter');

var _nuclideOutlineViewAdapter2 = _interopRequireDefault(_nuclideOutlineViewAdapter);

var _atom = require('atom');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

let AutoLanguageClient = class AutoLanguageClient {
  constructor() {
    this._disposable = new _atom.CompositeDisposable();
  }

  getGrammarScopes() {
    throw "Must implement getGrammarScopes when extending AutoLanguageClient";
  }
  getLanguageName() {
    throw "Must implement getLanguageName when extending AutoLanguageClient";
  }
  getServerName() {
    throw "Must implement getServerName when extending AutoLanguageClient";
  }

  activate() {
    this.name = `${this.getLanguageName()} (${this.getServerName()})`;
    this.logger = atom.config.get('core.debugLSP') ? new _consoleLogger2.default(this.name) : new _nullLogger2.default();
    this.startServer();
  }

  deactivate() {
    this._disposable.dispose();

    if (this._lc) {
      this._lc.shutdown();
    }

    if (this._process != null) {
      this._process.kill();
      this._process = null;
    };
  }

  startServer() {
    var _this = this;

    return _asyncToGenerator(function* () {
      if (_this._process != null) return;

      _this._process = yield _this.startServerProcess();

      const connection = rpc.createMessageConnection(new rpc.StreamMessageReader(_this._process.stdout), new rpc.StreamMessageWriter(_this._process.stdin), { error: function (m) {
          _this.logger.error(m);
        } });

      _this._lc = new ls.LanguageClientConnection(connection, _this.logger);
      _this._lc.onLogMessage(function (m) {
        return _this.logger.log(['Log', m]);
      });
      _this.preInitialization();

      const initializeResponse = yield _this._lc.initialize(_this.getInitializeParams());
      _this.adaptCapabilities(initializeResponse.capabilities);
      _this.postInitialization(initializeResponse);
    })();
  }

  startServerProcess() {
    throw "Must override startServerProcess to start the language server process when extending AutoLanguageClient";
  }

  getProjectRoot() {
    const rootDirs = atom.project.getDirectories();
    return rootDirs.length > 0 ? rootDirs[0].path : null;
  }

  getInitializeParams() {
    return {
      processId: process.pid,
      capabilities: {},
      rootPath: this.getProjectRoot()
    };
  }

  adaptCapabilities(capabilities) {
    this.linter = new _linterAdapter2.default(this._lc);
    if (capabilities.completionProvider) {
      this.autoComplete = new _autocompleteAdapter2.default(this._lc);
    }
    if (capabilities.definitionProvider) {
      this.definitions = new _nuclideDefinitionAdapter2.default(this._lc);
      this.hyperclick = new _nuclideHyperclickAdapter2.default(this._lc);
    }
    if (capabilities.documentSymbolProvider) {
      this.outlineView = new _nuclideOutlineViewAdapter2.default(this._lc, this.name);
    }
    if (capabilities.referencesProvider) {
      this.findReferences = new _nuclideFindReferencesAdapter2.default(this._lc);
    }

    new _notificationsAdapter2.default(this._lc, this.name);

    if (capabilities.textDocumentSync) {
      this._disposable.add(new _documentSyncAdapter2.default(this._lc, capabilities.textDocumentSync));
    }
    if (capabilities.documentRangeFormattingProvider || capabilities.documentFormattingProvider) {
      this._disposable.add(new _formatCodeAdapter2.default(this._lc, capabilities.documentRangeFormattingProvider === true, capabilities.documentFormattingProvider === true, this.getGrammarScopes()));
    }
  }

  preInitialization() {}

  postInitialization(InitializationResult) {}

  // Atom Autocomplete+ via LS completion

  provideAutocomplete() {
    return {
      selector: '.source',
      excludeLowerPriority: false,
      getSuggestions: this.getSuggestions.bind(this)
    };
  }

  getSuggestions(request) {
    return this.autoComplete != null ? this.autoComplete.getSuggestions(request) : Promise.resolve([]);
  }

  // Nuclide Definitions via LS documentHighlight and gotoDefinition

  provideDefinitions() {
    return {
      name: this.name,
      priority: 20,
      grammarScopes: this.getGrammarScopes(),
      getDefinition: this.getDefinition.bind(this),
      getDefinitionById: this.getDefinitionById.bind(this)
    };
  }

  getDefinition(editor, point) {
    return this.definitions != null ? this.definitions.getDefinition(editor, point) : Promise.resolve(null);
  }

  getDefinitionById(filename, id) {
    return Promise.resolve(null); // TODO: Is this needed?
  }

  // Nuclide Outline View via LS documentSymbol

  provideOutlines() {
    return {
      name: this.name,
      grammarScopes: this.getGrammarScopes(),
      priority: 1,
      getOutline: this.getOutline.bind(this)
    };
  }

  getOutline(editor) {
    return this.outlineView != null ? this.outlineView.getOutline(editor) : Promise.resolve(null);
  }

  // Linter API via LS publishDiagnostics

  provideLinter() {
    return {
      name: this.name,
      grammarScopes: this.getGrammarScopes(),
      scope: 'project',
      lintOnFly: true,
      lint: this.getLinting.bind(this)
    };
  }

  getLinting(editor) {
    return this.linter != null ? this.linter.provideDiagnostics() : Promise.resolve([]);
  }

  // Nuclide Find References via LS findReferences

  provideFindReferences() {
    return {
      isEditorSupported: editor => this.getGrammarScopes().includes(editor.getGrammar().scopeName),
      findReferences: this.getReferences.bind(this)
    };
  }

  getReferences(editor, point) {
    return this.findReferences != null ? this.findReferences.getReferences(editor, point, this.getProjectRoot()) : Promise.resolve(null);
  }

  // Nuclide Hyperlick via LS gotoDefinition and documentHighlight

  provideHyperclick() {
    return {
      priority: 20,
      providerName: this.name,
      getSuggestion: this.getHyperclickSuggestion.bind(this)
    };
  }

  getHyperclickSuggestion(editor, point) {
    return this.hyperclick != null ? this.hyperclick.getSuggestion(editor, point) : Promise.resolve(null);
  }
};
exports.default = AutoLanguageClient;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi9hdXRvLWxhbmd1YWdlY2xpZW50LmpzIl0sIm5hbWVzIjpbImNwIiwibHMiLCJycGMiLCJBdXRvTGFuZ3VhZ2VDbGllbnQiLCJfZGlzcG9zYWJsZSIsImdldEdyYW1tYXJTY29wZXMiLCJnZXRMYW5ndWFnZU5hbWUiLCJnZXRTZXJ2ZXJOYW1lIiwiYWN0aXZhdGUiLCJuYW1lIiwibG9nZ2VyIiwiYXRvbSIsImNvbmZpZyIsImdldCIsInN0YXJ0U2VydmVyIiwiZGVhY3RpdmF0ZSIsImRpc3Bvc2UiLCJfbGMiLCJzaHV0ZG93biIsIl9wcm9jZXNzIiwia2lsbCIsInN0YXJ0U2VydmVyUHJvY2VzcyIsImNvbm5lY3Rpb24iLCJjcmVhdGVNZXNzYWdlQ29ubmVjdGlvbiIsIlN0cmVhbU1lc3NhZ2VSZWFkZXIiLCJzdGRvdXQiLCJTdHJlYW1NZXNzYWdlV3JpdGVyIiwic3RkaW4iLCJlcnJvciIsIm0iLCJMYW5ndWFnZUNsaWVudENvbm5lY3Rpb24iLCJvbkxvZ01lc3NhZ2UiLCJsb2ciLCJwcmVJbml0aWFsaXphdGlvbiIsImluaXRpYWxpemVSZXNwb25zZSIsImluaXRpYWxpemUiLCJnZXRJbml0aWFsaXplUGFyYW1zIiwiYWRhcHRDYXBhYmlsaXRpZXMiLCJjYXBhYmlsaXRpZXMiLCJwb3N0SW5pdGlhbGl6YXRpb24iLCJnZXRQcm9qZWN0Um9vdCIsInJvb3REaXJzIiwicHJvamVjdCIsImdldERpcmVjdG9yaWVzIiwibGVuZ3RoIiwicGF0aCIsInByb2Nlc3NJZCIsInByb2Nlc3MiLCJwaWQiLCJyb290UGF0aCIsImxpbnRlciIsImNvbXBsZXRpb25Qcm92aWRlciIsImF1dG9Db21wbGV0ZSIsImRlZmluaXRpb25Qcm92aWRlciIsImRlZmluaXRpb25zIiwiaHlwZXJjbGljayIsImRvY3VtZW50U3ltYm9sUHJvdmlkZXIiLCJvdXRsaW5lVmlldyIsInJlZmVyZW5jZXNQcm92aWRlciIsImZpbmRSZWZlcmVuY2VzIiwidGV4dERvY3VtZW50U3luYyIsImFkZCIsImRvY3VtZW50UmFuZ2VGb3JtYXR0aW5nUHJvdmlkZXIiLCJkb2N1bWVudEZvcm1hdHRpbmdQcm92aWRlciIsIkluaXRpYWxpemF0aW9uUmVzdWx0IiwicHJvdmlkZUF1dG9jb21wbGV0ZSIsInNlbGVjdG9yIiwiZXhjbHVkZUxvd2VyUHJpb3JpdHkiLCJnZXRTdWdnZXN0aW9ucyIsImJpbmQiLCJyZXF1ZXN0IiwiUHJvbWlzZSIsInJlc29sdmUiLCJwcm92aWRlRGVmaW5pdGlvbnMiLCJwcmlvcml0eSIsImdyYW1tYXJTY29wZXMiLCJnZXREZWZpbml0aW9uIiwiZ2V0RGVmaW5pdGlvbkJ5SWQiLCJlZGl0b3IiLCJwb2ludCIsImZpbGVuYW1lIiwiaWQiLCJwcm92aWRlT3V0bGluZXMiLCJnZXRPdXRsaW5lIiwicHJvdmlkZUxpbnRlciIsInNjb3BlIiwibGludE9uRmx5IiwibGludCIsImdldExpbnRpbmciLCJwcm92aWRlRGlhZ25vc3RpY3MiLCJwcm92aWRlRmluZFJlZmVyZW5jZXMiLCJpc0VkaXRvclN1cHBvcnRlZCIsImluY2x1ZGVzIiwiZ2V0R3JhbW1hciIsInNjb3BlTmFtZSIsImdldFJlZmVyZW5jZXMiLCJwcm92aWRlSHlwZXJjbGljayIsInByb3ZpZGVyTmFtZSIsImdldFN1Z2dlc3Rpb24iLCJnZXRIeXBlcmNsaWNrU3VnZ2VzdGlvbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFFQTs7SUFBWUEsRTs7QUFDWjs7SUFBWUMsRTs7QUFDWjs7SUFBWUMsRzs7QUFFWjs7OztBQUNBOzs7O0FBRUE7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBRUE7Ozs7Ozs7O0lBRXFCQyxrQixHQUFOLE1BQU1BLGtCQUFOLENBQXlCO0FBQUE7QUFBQSxTQUN0Q0MsV0FEc0MsR0FDeEIsK0JBRHdCO0FBQUE7O0FBZ0J0Q0MscUJBQWtDO0FBQUUsVUFBTSxtRUFBTjtBQUEyRTtBQUMvR0Msb0JBQTBCO0FBQUUsVUFB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LEdBQXlFUixRQUFRQyxPQUFSLENBQWdCLElBQWhCLENBQWhGO0FBQ0Q7QUFyTXFDLEM7a0JBQW5CckUsa0IiLCJmaWxlIjoiYXV0by1sYW5ndWFnZWNsaWVudC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCAqIGFzIGNwIGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0ICogYXMgbHMgZnJvbSAnLi9sYW5ndWFnZWNsaWVudCc7XG5pbXBvcnQgKiBhcyBycGMgZnJvbSAndnNjb2RlLWpzb25ycGMnO1xuXG5pbXBvcnQgQ29uc29sZUxvZ2dlciBmcm9tICcuL2xvZ2dlcnMvY29uc29sZS1sb2dnZXInO1xuaW1wb3J0IE51bGxMb2dnZXIgZnJvbSAnLi9sb2dnZXJzL251bGwtbG9nZ2VyJztcblxuaW1wb3J0IEF1dG9jb21wbGV0ZUFkYXB0ZXIgZnJvbSAnLi9hZGFwdGVycy9hdXRvY29tcGxldGUtYWRhcHRlcic7XG5pbXBvcnQgRG9jdW1lbnRTeW5jQWRhcHRlciBmcm9tICcuL2FkYXB0ZXJzL2RvY3VtZW50LXN5bmMtYWRhcHRlcic7XG5pbXBvcnQgRm9ybWF0Q29kZUFkYXB0ZXIgZnJvbSAnLi9hZGFwdGVycy9mb3JtYXQtY29kZS1hZGFwdGVyJztcbmltcG9ydCBMaW50ZXJBZGFwdGVyIGZyb20gJy4vYWRhcHRlcnMvbGludGVyLWFkYXB0ZXInO1xuaW1wb3J0IE5vdGlmaWNhdGlvbnNBZGFwdGVyIGZyb20gJy4vYWRhcHRlcnMvbm90aWZpY2F0aW9ucy1hZGFwdGVyJztcbmltcG9ydCBOdWNsaWRlRGVmaW5pdGlvbkFkYXB0ZXIgZnJvbSAnLi9hZGFwdGVycy9udWNsaWRlLWRlZmluaXRpb24tYWRhcHRlcic7XG5pbXBvcnQgTnVjbGlkZUZpbmRSZWZlcmVuY2VzQWRhcHRlciBmcm9tICcuL2FkYXB0ZXJzL251Y2xpZGUtZmluZC1yZWZlcmVuY2VzLWFkYXB0ZXInO1xuaW1wb3J0IE51Y2xpZGVIeXBlcmNsaWNrQWRhcHRlciBmcm9tICcuL2FkYXB0ZXJzL251Y2xpZGUtaHlwZXJjbGljay1hZGFwdGVyJztcbmltcG9ydCBOdWNsaWRlT3V0bGluZVZpZXdBZGFwdGVyIGZyb20gJy4vYWRhcHRlcnMvbnVjbGlkZS1vdXRsaW5lLXZpZXctYWRhcHRlcic7XG5cbmltcG9ydCB7Q29tcG9zaXRlRGlzcG9zYWJsZX0gZnJvbSAnYXRvbSc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEF1dG9MYW5ndWFnZUNsaWVudCB7XG4gIF9kaXNwb3NhYmxlID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcbiAgX3Byb2Nlc3M6ID9jaGlsZF9wcm9jZXNzJENoaWxkUHJvY2VzcztcbiAgX2xjOiBscy5MYW5ndWFnZUNsaWVudENvbm5lY3Rpb247XG5cbiAgYXV0b0NvbXBsZXRlOiA/QXV0b2NvbXBsZXRlQWRhcHRlcjtcbiAgbGludGVyOiA/TGludGVyQWRhcHRlcjtcblxuICBkZWZpbml0aW9uczogP051Y2xpZGVEZWZpbml0aW9uQWRhcHRlcjtcbiAgZmluZFJlZmVyZW5jZXM6ID9OdWNsaWRlRmluZFJlZmVyZW5jZXNBZGFwdGVyO1xuICBoeXBlcmNsaWNrOiA/TnVjbGlkZUh5cGVyY2xpY2tBZGFwdGVyO1xuICBvdXRsaW5lVmlldzogP051Y2xpZGVPdXRsaW5lVmlld0FkYXB0ZXI7XG5cbiAgbG9nZ2VyOiBDb25zb2xlTG9nZ2VyIHwgTnVsbExvZ2dlcjtcbiAgbmFtZTogc3RyaW5nO1xuXG4gIGdldEdyYW1tYXJTY29wZXMoKTogQXJyYXk8c3RyaW5nPiB7IHRocm93IFwiTXVzdCBpbXBsZW1lbnQgZ2V0R3JhbW1hclNjb3BlcyB3aGVuIGV4dGVuZGluZyBBdXRvTGFuZ3VhZ2VDbGllbnRcIiB9O1xuICBnZXRMYW5ndWFnZU5hbWUoKTogc3RyaW5nIHsgdGhyb3cgXCJNdXN0IGltcGxlbWVudCBnZXRMYW5ndWFnZU5hbWUgd2hlbiBleHRlbmRpbmcgQXV0b0xhbmd1YWdlQ2xpZW50XCIgfTtcbiAgZ2V0U2VydmVyTmFtZSgpOiBzdHJpbmcgeyB0aHJvdyBcIk11c3QgaW1wbGVtZW50IGdldFNlcnZlck5hbWUgd2hlbiBleHRlbmRpbmcgQXV0b0xhbmd1YWdlQ2xpZW50XCIgfTtcblxuICBhY3RpdmF0ZSgpOiB2b2lkIHtcbiAgICB0aGlzLm5hbWUgPSBgJHt0aGlzLmdldExhbmd1YWdlTmFtZSgpfSAoJHt0aGlzLmdldFNlcnZlck5hbWUoKX0pYDtcbiAgICB0aGlzLmxvZ2dlciA9IGF0b20uY29uZmlnLmdldCgnY29yZS5kZWJ1Z0xTUCcpID8gbmV3IENvbnNvbGVMb2dnZXIodGhpcy5uYW1lKSA6IG5ldyBOdWxsTG9nZ2VyKCk7XG4gICAgdGhpcy5zdGFydFNlcnZlcigpO1xuICB9XG5cbiAgZGVhY3RpdmF0ZSgpOiB2b2lkIHtcbiAgICB0aGlzLl9kaXNwb3NhYmxlLmRpc3Bvc2UoKTtcblxuICAgIGlmICh0aGlzLl9sYykge1xuICAgICAgdGhpcy5fbGMuc2h1dGRvd24oKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5fcHJvY2VzcyAhPSBudWxsKSB7XG4gICAgICB0aGlzLl9wcm9jZXNzLmtpbGwoKTtcbiAgICAgIHRoaXMuX3Byb2Nlc3MgPSBudWxsO1xuICAgIH07XG4gIH1cblxuICBhc3luYyBzdGFydFNlcnZlcigpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAodGhpcy5fcHJvY2VzcyAhPSBudWxsKSByZXR1cm47XG5cbiAgICB0aGlzLl9wcm9jZXNzID0gYXdhaXQgdGhpcy5zdGFydFNlcnZlclByb2Nlc3MoKTtcblxuICAgIGNvbnN0IGNvbm5lY3Rpb24gPSBycGMuY3JlYXRlTWVzc2FnZUNvbm5lY3Rpb24oXG4gICAgICBuZXcgcnBjLlN0cmVhbU1lc3NhZ2VSZWFkZXIodGhpcy5fcHJvY2Vzcy5zdGRvdXQpLFxuICAgICAgbmV3IHJwYy5TdHJlYW1NZXNzYWdlV3JpdGVyKHRoaXMuX3Byb2Nlc3Muc3RkaW4pLFxuICAgICAgeyBlcnJvcjogKG06IE9iamVjdCkgPT4geyB0aGlzLmxvZ2dlci5lcnJvcihtKTsgfSB9KTtcblxuICAgIHRoaXMuX2xjID0gbmV3IGxzLkxhbmd1YWdlQ2xpZW50Q29ubmVjdGlvbihjb25uZWN0aW9uLCB0aGlzLmxvZ2dlcik7XG4gICAgdGhpcy5fbGMub25Mb2dNZXNzYWdlKG0gPT4gdGhpcy5sb2dnZXIubG9nKFsnTG9nJywgbV0pKTtcbiAgICB0aGlzLnByZUluaXRpYWxpemF0aW9uKCk7XG5cbiAgICBjb25zdCBpbml0aWFsaXplUmVzcG9uc2UgPSBhd2FpdCB0aGlzLl9sYy5pbml0aWFsaXplKHRoaXMuZ2V0SW5pdGlhbGl6ZVBhcmFtcygpKTtcbiAgICB0aGlzLmFkYXB0Q2FwYWJpbGl0aWVzKGluaXRpYWxpemVSZXNwb25zZS5jYXBhYmlsaXRpZXMpO1xuICAgIHRoaXMucG9zdEluaXRpYWxpemF0aW9uKGluaXRpYWxpemVSZXNwb25zZSk7XG4gIH1cblxuICBzdGFydFNlcnZlclByb2Nlc3MoKTogY2hpbGRfcHJvY2VzcyRDaGlsZFByb2Nlc3Mge1xuICAgIHRocm93IFwiTXVzdCBvdmVycmlkZSBzdGFydFNlcnZlclByb2Nlc3MgdG8gc3RhcnQgdGhlIGxhbmd1YWdlIHNlcnZlciBwcm9jZXNzIHdoZW4gZXh0ZW5kaW5nIEF1dG9MYW5ndWFnZUNsaWVudFwiO1xuICB9XG5cbiAgZ2V0UHJvamVjdFJvb3QoKTogP3N0cmluZyB7XG4gICAgY29uc3Qgcm9vdERpcnM6IEFycmF5PGFueT4gPSBhdG9tLnByb2plY3QuZ2V0RGlyZWN0b3JpZXMoKTtcbiAgICByZXR1cm4gcm9vdERpcnMubGVuZ3RoID4gMCA/IHJvb3REaXJzWzBdLnBhdGggOiBudWxsXG4gIH1cblxuICBnZXRJbml0aWFsaXplUGFyYW1zKCk6IGxzLkluaXRpYWxpemVQYXJhbXMge1xuICAgIHJldHVybiB7XG4gICAgICBwcm9jZXNzSWQ6IHByb2Nlc3MucGlkLFxuICAgICAgY2FwYWJpbGl0aWVzOiB7IH0sXG4gICAgICByb290UGF0aDogdGhpcy5nZXRQcm9qZWN0Um9vdCgpXG4gICAgfTtcbiAgfVxuXG4gIGFkYXB0Q2FwYWJpbGl0aWVzKGNhcGFiaWxpdGllczogbHMuU2VydmVyQ2FwYWJpbGl0aWVzKTogdm9pZCB7XG4gICAgdGhpcy5saW50ZXIgPSBuZXcgTGludGVyQWRhcHRlcih0aGlzLl9sYyk7XG4gICAgaWYgKGNhcGFiaWxpdGllcy5jb21wbGV0aW9uUHJvdmlkZXIpIHtcbiAgICAgIHRoaXMuYXV0b0NvbXBsZXRlID0gbmV3IEF1dG9jb21wbGV0ZUFkYXB0ZXIodGhpcy5fbGMpO1xuICAgIH1cbiAgICBpZiAoY2FwYWJpbGl0aWVzLmRlZmluaXRpb25Qcm92aWRlcikge1xuICAgICAgdGhpcy5kZWZpbml0aW9ucyA9IG5ldyBOdWNsaWRlRGVmaW5pdGlvbkFkYXB0ZXIodGhpcy5fbGMpO1xuICAgICAgdGhpcy5oeXBlcmNsaWNrID0gbmV3IE51Y2xpZGVIeXBlcmNsaWNrQWRhcHRlcih0aGlzLl9sYyk7XG4gICAgfVxuICAgIGlmIChjYXBhYmlsaXRpZXMuZG9jdW1lbnRTeW1ib2xQcm92aWRlcikge1xuICAgICAgdGhpcy5vdXRsaW5lVmlldyA9IG5ldyBOdWNsaWRlT3V0bGluZVZpZXdBZGFwdGVyKHRoaXMuX2xjLCB0aGlzLm5hbWUpO1xuICAgIH1cbiAgICBpZiAoY2FwYWJpbGl0aWVzLnJlZmVyZW5jZXNQcm92aWRlcikge1xuICAgICAgdGhpcy5maW5kUmVmZXJlbmNlcyA9IG5ldyBOdWNsaWRlRmluZFJlZmVyZW5jZXNBZGFwdGVyKHRoaXMuX2xjKTtcbiAgICB9XG5cbiAgICBuZXcgTm90aWZpY2F0aW9uc0FkYXB0ZXIodGhpcy5fbGMsIHRoaXMubmFtZSk7XG5cbiAgICBpZiAoY2FwYWJpbGl0aWVzLnRleHREb2N1bWVudFN5bmMpIHtcbiAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKG5ldyBEb2N1bWVudFN5bmNBZGFwdGVyKHRoaXMuX2xjLCBjYXBhYmlsaXRpZXMudGV4dERvY3VtZW50U3luYykpO1xuICAgIH1cbiAgICBpZiAoY2FwYWJpbGl0aWVzLmRvY3VtZW50UmFuZ2VGb3JtYXR0aW5nUHJvdmlkZXIgfHwgY2FwYWJpbGl0aWVzLmRvY3VtZW50Rm9ybWF0dGluZ1Byb3ZpZGVyKSB7XG4gICAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChuZXcgRm9ybWF0Q29kZUFkYXB0ZXIodGhpcy5fbGMsIGNhcGFiaWxpdGllcy5kb2N1bWVudFJhbmdlRm9ybWF0dGluZ1Byb3ZpZGVyID09PSB0cnVlLCBjYXBhYmlsaXRpZXMuZG9jdW1lbnRGb3JtYXR0aW5nUHJvdmlkZXIgPT09IHRydWUsIHRoaXMuZ2V0R3JhbW1hclNjb3BlcygpKSk7XG4gICAgfVxuICB9XG5cbiAgcHJlSW5pdGlhbGl6YXRpb24oKTogdm9pZCB7XG4gIH1cblxuICBwb3N0SW5pdGlhbGl6YXRpb24oSW5pdGlhbGl6YXRpb25SZXN1bHQ6IGxzLkluaXRpYWxpemVSZXN1bHQpOiB2b2lkIHtcbiAgfVxuXG4gIC8vIEF0b20gQXV0b2NvbXBsZXRlKyB2aWEgTFMgY29tcGxldGlvblxuXG4gIHByb3ZpZGVBdXRvY29tcGxldGUoKTogYXRvbSRBdXRvY29tcGxldGVQcm92aWRlciB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHNlbGVjdG9yOiAnLnNvdXJjZScsXG4gICAgICBleGNsdWRlTG93ZXJQcmlvcml0eTogZmFsc2UsXG4gICAgICBnZXRTdWdnZXN0aW9uczogdGhpcy5nZXRTdWdnZXN0aW9ucy5iaW5kKHRoaXMpXG4gICAgfTtcbiAgfVxuXG4gIGdldFN1Z2dlc3Rpb25zKHJlcXVlc3Q6IGFueSk6IFByb21pc2U8QXJyYXk8YXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9uPj4ge1xuICAgIHJldHVybiB0aGlzLmF1dG9Db21wbGV0ZSAhPSBudWxsID8gdGhpcy5hdXRvQ29tcGxldGUuZ2V0U3VnZ2VzdGlvbnMocmVxdWVzdCkgOiBQcm9taXNlLnJlc29sdmUoW10pO1xuICB9XG5cbiAgLy8gTnVjbGlkZSBEZWZpbml0aW9ucyB2aWEgTFMgZG9jdW1lbnRIaWdobGlnaHQgYW5kIGdvdG9EZWZpbml0aW9uXG5cbiAgcHJvdmlkZURlZmluaXRpb25zKCk6IG51Y2xpZGUkRGVmaW5pdGlvblByb3ZpZGVyIHtcbiAgICByZXR1cm4ge1xuICAgICAgbmFtZTogdGhpcy5uYW1lLFxuICAgICAgcHJpb3JpdHk6IDIwLFxuICAgICAgZ3JhbW1hclNjb3BlczogdGhpcy5nZXRHcmFtbWFyU2NvcGVzKCksXG4gICAgICBnZXREZWZpbml0aW9uOiB0aGlzLmdldERlZmluaXRpb24uYmluZCh0aGlzKSxcbiAgICAgIGdldERlZmluaXRpb25CeUlkOiB0aGlzLmdldERlZmluaXRpb25CeUlkLmJpbmQodGhpcylcbiAgICB9XG4gIH1cblxuICBnZXREZWZpbml0aW9uKGVkaXRvcjogVGV4dEVkaXRvciwgcG9pbnQ6IGF0b20kUG9pbnQpOiBQcm9taXNlPD9udWNsaWRlJERlZmluaXRpb25RdWVyeVJlc3VsdD4ge1xuICAgIHJldHVybiB0aGlzLmRlZmluaXRpb25zICE9IG51bGwgPyB0aGlzLmRlZmluaXRpb25zLmdldERlZmluaXRpb24oZWRpdG9yLCBwb2ludCkgOiBQcm9taXNlLnJlc29sdmUobnVsbCk7XG4gIH1cblxuICBnZXREZWZpbml0aW9uQnlJZChmaWxlbmFtZTogTnVjbGlkZVVyaSwgaWQ6IHN0cmluZyk6IFByb21pc2U8P251Y2xpZGUkRGVmaW5pdGlvbj4ge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobnVsbCk7IC8vIFRPRE86IElzIHRoaXMgbmVlZGVkP1xuICB9XG5cbiAgLy8gTnVjbGlkZSBPdXRsaW5lIFZpZXcgdmlhIExTIGRvY3VtZW50U3ltYm9sXG5cbiAgcHJvdmlkZU91dGxpbmVzKCk6IG51Y2xpZGUkT3V0bGluZVByb3ZpZGVyIHtcbiAgICByZXR1cm4ge1xuICAgICAgbmFtZTogdGhpcy5uYW1lLFxuICAgICAgZ3JhbW1hclNjb3BlczogdGhpcy5nZXRHcmFtbWFyU2NvcGVzKCksXG4gICAgICBwcmlvcml0eTogMSxcbiAgICAgIGdldE91dGxpbmU6IHRoaXMuZ2V0T3V0bGluZS5iaW5kKHRoaXMpXG4gICAgfTtcbiAgfVxuXG4gIGdldE91dGxpbmUoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpOiBQcm9taXNlPD9udWNsaWRlJE91dGxpbmU+IHtcbiAgICByZXR1cm4gdGhpcy5vdXRsaW5lVmlldyAhPSBudWxsID8gdGhpcy5vdXRsaW5lVmlldy5nZXRPdXRsaW5lKGVkaXRvcikgOiBQcm9taXNlLnJlc29sdmUobnVsbCk7XG4gIH1cblxuICAvLyBMaW50ZXIgQVBJIHZpYSBMUyBwdWJsaXNoRGlhZ25vc3RpY3NcblxuICBwcm92aWRlTGludGVyKCk6IGxpbnRlciRTdGFuZGFyZExpbnRlciB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWU6IHRoaXMubmFtZSxcbiAgICAgIGdyYW1tYXJTY29wZXM6IHRoaXMuZ2V0R3JhbW1hclNjb3BlcygpLFxuICAgICAgc2NvcGU6ICdwcm9qZWN0JyxcbiAgICAgIGxpbnRPbkZseTogdHJ1ZSxcbiAgICAgIGxpbnQ6IHRoaXMuZ2V0TGludGluZy5iaW5kKHRoaXMpXG4gICAgfTtcbiAgfVxuXG4gIGdldExpbnRpbmcoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpOiA/QXJyYXk8bGludGVyJE1lc3NhZ2U+IHwgUHJvbWlzZTw/QXJyYXk8bGludGVyJE1lc3NhZ2U+PiB7XG4gICAgcmV0dXJuIHRoaXMubGludGVyICE9IG51bGwgPyB0aGlzLmxpbnRlci5wcm92aWRlRGlhZ25vc3RpY3MoKSA6IFByb21pc2UucmVzb2x2ZShbXSk7XG4gIH1cblxuICAvLyBOdWNsaWRlIEZpbmQgUmVmZXJlbmNlcyB2aWEgTFMgZmluZFJlZmVyZW5jZXNcblxuICBwcm92aWRlRmluZFJlZmVyZW5jZXMoKTogbnVjbGlkZSRGaW5kUmVmZXJlbmNlc1Byb3ZpZGVyIHtcbiAgICByZXR1cm4ge1xuICAgICAgaXNFZGl0b3JTdXBwb3J0ZWQ6IChlZGl0b3I6IGF0b20kVGV4dEVkaXRvcikgPT4gdGhpcy5nZXRHcmFtbWFyU2NvcGVzKCkuaW5jbHVkZXMoZWRpdG9yLmdldEdyYW1tYXIoKS5zY29wZU5hbWUpLFxuICAgICAgZmluZFJlZmVyZW5jZXM6IHRoaXMuZ2V0UmVmZXJlbmNlcy5iaW5kKHRoaXMpXG4gICAgfVxuICB9XG5cbiAgZ2V0UmVmZXJlbmNlcyhlZGl0b3I6IGF0b20kVGV4dEVkaXRvciwgcG9pbnQ6IGF0b20kUG9pbnQpOiBQcm9taXNlPD9udWNsaWRlJEZpbmRSZWZlcmVuY2VzUmV0dXJuPiB7XG4gICAgcmV0dXJuIHRoaXMuZmluZFJlZmVyZW5jZXMgIT0gbnVsbCA/IHRoaXMuZmluZFJlZmVyZW5jZXMuZ2V0UmVmZXJlbmNlcyhlZGl0b3IsIHBvaW50LCB0aGlzLmdldFByb2plY3RSb290KCkpIDogUHJvbWlzZS5yZXNvbHZlKG51bGwpO1xuICB9XG5cbiAgLy8gTnVjbGlkZSBIeXBlcmxpY2sgdmlhIExTIGdvdG9EZWZpbml0aW9uIGFuZCBkb2N1bWVudEhpZ2hsaWdodFxuXG4gIHByb3ZpZGVIeXBlcmNsaWNrKCk6IG51Y2xpZGUkSHlwZXJjbGlja1Byb3ZpZGVyIHtcbiAgICByZXR1cm4ge1xuICAgICAgcHJpb3JpdHk6IDIwLFxuICAgICAgcHJvdmlkZXJOYW1lOiB0aGlzLm5hbWUsXG4gICAgICBnZXRTdWdnZXN0aW9uOiB0aGlzLmdldEh5cGVyY2xpY2tTdWdnZXN0aW9uLmJpbmQodGhpcylcbiAgICB9O1xuICB9XG5cbiAgZ2V0SHlwZXJjbGlja1N1Z2dlc3Rpb24oZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsIHBvaW50OiBhdG9tJFBvaW50KTogUHJvbWlzZTw/bnVjbGlkZSRIeXBlcmNsaWNrU3VnZ2VzdGlvbj4ge1xuICAgIHJldHVybiB0aGlzLmh5cGVyY2xpY2sgIT0gbnVsbCA/IHRoaXMuaHlwZXJjbGljay5nZXRTdWdnZXN0aW9uKGVkaXRvciwgcG9pbnQpIDogUHJvbWlzZS5yZXNvbHZlKG51bGwpO1xuICB9XG59XG4iXX0=